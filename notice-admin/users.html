<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ユーザー閲覧 - 管理者 - スポットライト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="stylesheet" href="../css/common.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/common.js" defer></script>
  <script src="../js/auth.js" defer></script>
  <style>
    .admin-container {
      max-width: 960px;
      margin: 0 auto;
      padding: 120px 20px 80px;
      position: relative;
      z-index: 1;
    }
    .admin-card {
      background: rgba(26, 26, 46, 0.85);
      border: 1px solid rgba(99, 102, 241, 0.35);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 12px 40px rgba(2, 6, 23, 0.6);
    }
    .list-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }
    .user-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(99, 102, 241, 0.35);
      background: rgba(5, 8, 22, 0.85);
    }
    .user-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(99, 102, 241, 0.4);
      background: rgba(255, 255, 255, 0.04);
    }
    .user-id {
      font-size: 12px;
      color: var(--light-gray);
    }
    .pager {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .admin-button {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: linear-gradient(135deg, var(--purple), var(--pink));
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      min-width: 120px;
    }
    .admin-status {
      margin-top: 12px;
      font-size: 14px;
      color: var(--light-gray);
    }
    .link-back {
      color: var(--light-gray);
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="animated-bg">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
  </div>
  <div class="particles" id="particles"></div>
  <div id="header-placeholder"></div>

  <main class="admin-container">
    <h1 class="section-title fade-in">ユーザー閲覧</h1>
    <p class="fade-in" style="opacity: 0.8; margin-bottom: 18px;">
      管理者のみ利用できます。最新10件を降順で表示します。
    </p>
    <p><a class="link-back" href="/notice-admin/">← 管理者トップへ戻る</a></p>

    <div class="admin-card fade-in">
      <div class="list-grid" id="userList" aria-live="polite"></div>
      <p id="status" class="admin-status">読み込み中...</p>
      <div class="pager">
        <button id="prevBtn" class="admin-button" disabled>前の10件</button>
        <button id="nextBtn" class="admin-button">次の10件</button>
      </div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    (function() {
      var jwt = null;
      var statusEl = document.getElementById('status');
      var listEl = document.getElementById('userList');
      var prevBtn = document.getElementById('prevBtn');
      var nextBtn = document.getElementById('nextBtn');
      var offset = 0;
      var pageSize = 10;

      function setStatus(msg, isError) {
        if (!statusEl) return;
        statusEl.textContent = msg || '';
        statusEl.style.color = isError ? '#fca5a5' : 'var(--light-gray)';
      }

      function renderUsers(users) {
        if (!listEl) return;
        listEl.innerHTML = '';
        if (!users || users.length === 0) {
          listEl.innerHTML = '<div class="user-item">ユーザーが見つかりません。</div>';
          return;
        }
        users.forEach(function(u) {
          var item = document.createElement('div');
          item.className = 'user-item';
          var img = document.createElement('img');
          img.className = 'user-icon';
          img.src = u.iconimgpath || '/picture/default-icon.png';
          img.alt = u.username || 'user icon';
          img.loading = 'lazy';
          var infoWrap = document.createElement('div');
          var nameEl = document.createElement('div');
          nameEl.textContent = u.username || '(no name)';
          nameEl.style.fontWeight = '700';
          var idEl = document.createElement('div');
          idEl.className = 'user-id';
          idEl.textContent = 'ID: ' + (u.userID || '-');
          infoWrap.appendChild(nameEl);
          infoWrap.appendChild(idEl);
          item.appendChild(img);
          item.appendChild(infoWrap);
          listEl.appendChild(item);
        });
      }

      function updatePager(hasNext) {
        prevBtn.disabled = offset === 0;
        nextBtn.disabled = !hasNext;
      }

      function fetchPage() {
        if (!jwt) return;
        setStatus('読み込み中...');
        window.SpotlightApi.fetchAdminUsers(jwt, offset)
          .then(function(users) {
            renderUsers(users);
            setStatus('');
            updatePager(users && users.length === pageSize);
          })
          .catch(function(err) {
            setStatus(err.message || '取得に失敗しました。', true);
          });
      }

      function requireLogin() {
        window.location.href = '/login/';
      }

      document.addEventListener('DOMContentLoaded', function() {
        if (window.SpotlightAuthEnvError) {
          setStatus(window.SpotlightAuthEnvError, true);
          return;
        }
        var auth = window.SpotlightAuth && window.SpotlightAuth.getAuth();
        if (!auth) {
          requireLogin();
          return;
        }
        auth.onAuthStateChanged(function(user) {
          if (!user) {
            requireLogin();
            return;
          }
          window.SpotlightAuth.getIdToken()
            .then(function(idToken) { return window.SpotlightApi.fetchJwt(idToken); })
            .then(function(j) {
              jwt = j;
              return window.SpotlightApi.fetchUserData(jwt);
            })
            .then(function(appUser) {
              if (!appUser || !appUser.admin) {
                setStatus('管理者権限がありません。', true);
                setTimeout(function() { window.location.href = '/'; }, 1200);
                return;
              }
              fetchPage();
            })
            .catch(function(err) {
              setStatus(err.message || '認証に失敗しました。', true);
            });
        });

        prevBtn.addEventListener('click', function() {
          if (offset === 0) return;
          offset = Math.max(0, offset - pageSize);
          fetchPage();
        });

        nextBtn.addEventListener('click', function() {
          offset += pageSize;
          fetchPage();
        });
      });
    })();
  </script>
</body>
</html>
