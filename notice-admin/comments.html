<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ユーザー閲覧 - 管理者 - スポットライト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="stylesheet" href="../css/common.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/api.js"></script>
  <script src="../js/common.js" defer></script>
  <script src="../js/auth.js" defer></script>
  <style>
    .admin-container {
      max-width: 960px;
      margin: 0 auto;
      padding: 120px 20px 80px;
      position: relative;
      z-index: 1;
    }
    .admin-card {
      background: rgba(26, 26, 46, 0.85);
      border: 1px solid rgba(99, 102, 241, 0.35);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 12px 40px rgba(2, 6, 23, 0.6);
    }
    .list-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }
    .user-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(99, 102, 241, 0.35);
      background: rgba(5, 8, 22, 0.85);
    }
    .user-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(99, 102, 241, 0.4);
      background: rgba(255, 255, 255, 0.04);
    }
    .user-id {
      font-size: 12px;
      color: var(--light-gray);
    }
    .pager {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .admin-button {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: linear-gradient(135deg, var(--purple), var(--pink));
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      min-width: 120px;
    }
    .admin-status {
      margin-top: 12px;
      font-size: 14px;
      color: var(--light-gray);
    }
    .link-back {
      color: var(--light-gray);
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="animated-bg">
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="gradient-orb orb-3"></div>
  </div>
  <div class="particles" id="particles"></div>
  <div id="header-placeholder"></div>

  <main class="admin-container">
    <h1 class="section-title fade-in">コメント閲覧</h1>
    <div class="admin-card">
        <div id="status" class="status"></div>
        <div id="commentList" class="commentList"></div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    (function() {
    
      var jwt = null;
      var statusEl = document.getElementById('status');
      var commentListEl = document.getElementById('commentList');
      var urlParams = new URLSearchParams(window.location.search);
      var contentID = parseInt(urlParams.get('contentID'), 10);
    
      function setStatus(msg, isError) {
        if (!statusEl) return;
        statusEl.textContent = msg || '';
        statusEl.style.color = isError ? '#fca5a5' : 'var(--light-gray)';
      }
    
      function requireLogin() {
        window.location.href = '/login/';
      }
    
      function loadComments() {
        if (!jwt) return;
    
        setStatus('コメントを読み込み中...');
    
        window.SpotlightApi.getContentComments(jwt, contentID)
          .then(function(data) {
            renderComments(data);
            setStatus('');
          })
          .catch(function(e) {
            setStatus(e.message || 'コメント取得に失敗しました。', true);
          });
      }
    
      function renderComments(comments, parentEl) {
    
        if (!parentEl) {
          parentEl = commentListEl;
          parentEl.innerHTML = '';
        }
    
        if (!comments || comments.length === 0) {
          parentEl.innerHTML = '<div>コメントはありません。</div>';
          return;
        }
    
        comments.forEach(function(c) {
    
          var container = document.createElement('div');
          container.className = 'comment-item';
          container.dataset.id = c.commentID;
    
          if (c.report_count > 0) {
            container.style.backgroundColor = 'rgba(255,0,0,0.1)';
          }
    
          var meta = document.createElement('div');
          meta.className = 'comment-meta';
          meta.textContent =
            'CommentID: ' + c.commentID +
            ' / ' + (c.username || '-') +
            ' / ' + (c.commenttimestamp || '-') +
            ' / 通報:' + (c.report_count || 0);
    
          var text = document.createElement('div');
          text.className = 'comment-text';
          text.textContent = c.commenttext || '';
    
          var delBtn = document.createElement('button');
          delBtn.className = 'admin-button';
          delBtn.textContent = '削除';
          delBtn.addEventListener('click', function() {
            deleteSingleComment(c.commentID);
          });
    
          container.appendChild(meta);
          container.appendChild(text);
          container.appendChild(delBtn);
    
          parentEl.appendChild(container);
    
          if (c.replies && c.replies.length > 0) {
            var replyWrapper = document.createElement('div');
            replyWrapper.style.marginLeft = '20px';
            replyWrapper.style.marginTop = '8px';
            container.appendChild(replyWrapper);
            renderComments(c.replies, replyWrapper);
          }
        });
      }
    
      function deleteSingleComment(commentID) {
    
        if (!confirm('このコメントを削除します。よろしいですか？')) return;
    
        setStatus('削除中...');
    
        window.SpotlightApi.deleteComment(jwt, contentID, commentID)
          .then(function() {
            loadComments();
            setStatus('コメントを削除しました。');
          })
          .catch(function(e) {
            setStatus(e.message || '削除に失敗しました。', true);
          });
      }
    
      document.addEventListener('DOMContentLoaded', function() {
    
        if (!contentID) {
          setStatus('contentIDが指定されていません。', true);
          return;
        }
    
        if (window.SpotlightAuthEnvError) {
          setStatus(window.SpotlightAuthEnvError, true);
          return;
        }
    
        var auth = window.SpotlightAuth && window.SpotlightAuth.getAuth();
        if (!auth) {
          requireLogin();
          return;
        }
    
        auth.onAuthStateChanged(function(user) {
    
          if (!user) {
            requireLogin();
            return;
          }
    
          window.SpotlightAuth.getIdToken()
            .then(function(idToken) {
              return window.SpotlightApi.fetchJwt(idToken);
            })
            .then(function(j) {
              jwt = j;
              return window.SpotlightApi.fetchUserData(jwt);
            })
            .then(function(appUser) {
    
              if (!appUser || !appUser.admin) {
                setStatus('管理者権限がありません。', true);
                setTimeout(function() { window.location.href = '/'; }, 1200);
                return;
              }
    
              loadComments();
            })
            .catch(function(err) {
              setStatus(err.message || '認証に失敗しました。', true);
            });
    
        });
    
      });
    
    })();
    </script>
    
    
  </body>
</html>
    