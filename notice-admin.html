<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>お知らせ管理 - SpotLight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <link rel="stylesheet" href="css/common.css">
  <style>
    body {
      background: #0b1020;
      color: var(--white);
    }

    .admin-container {
      max-width: 960px;
      margin: 0 auto;
      padding: 120px 20px 80px;
      position: relative;
      z-index: 1;
    }
    
    .admin-card {
      background: rgba(26, 26, 46, 0.85);
      border: 1px solid rgba(99, 102, 241, 0.35);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 12px 40px rgba(2, 6, 23, 0.6);
    }
    
    .admin-form {
      display: grid;
      gap: 16px;
    }
    
    .admin-form label {
      font-weight: 700;
      display: block;
      margin-bottom: 6px;
      color: var(--white);
    }
    
    .admin-form input,
    .admin-form select,
    .admin-form textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.45);
      background: rgba(5, 8, 22, 0.9);
      color: var(--white);
      padding: 12px 14px;
      font-size: 14px;
      outline: none;
    }
    
    .admin-form input:focus,
    .admin-form select:focus,
    .admin-form textarea:focus {
      border-color: rgba(236, 72, 153, 0.8);
      box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.2);
    }
    
    .admin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .admin-button {
      border-radius: 999px;
      padding: 12px 20px;
      border: none;
      background: linear-gradient(135deg, var(--purple), var(--pink));
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    
    .admin-button.secondary {
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.4);
      color: var(--white);
    }
    
    .notice-preview {
      display: grid;
      gap: 12px;
    }
    
    .notice-item {
      background: rgba(26, 26, 46, 0.75);
      border: 1px solid rgba(99, 102, 241, 0.25);
      border-radius: 16px;
      padding: 16px 20px;
    }
    
    .notice-meta {
      display: flex;
      gap: 10px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .notice-tag {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(99, 102, 241, 0.4);
      background: rgba(99, 102, 241, 0.2);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <script>
    const sessionKey = 'spotlight_notice_admin_auth';
    const hasAuth = sessionStorage.getItem(sessionKey) === 'ok';
    if (!hasAuth) {
      const input = window.prompt('管理用パスコードを入力してください');
      if (input && input === adminKey) {
        sessionStorage.setItem(sessionKey, 'ok');
      } else {
        window.location.href = '/';
      }
    }
  </script>
  <div class="admin-container">
    <h1 class="section-title fade-in">お知らせ管理</h1>
    <p class="fade-in" style="opacity: 0.8; margin-bottom: 30px;">
      ここで作成したJSONをダウンロードして、`notices.json`を置き換えると反映されます。
      既存のお知らせは自動で読み込み、履歴が残るように結合します。
    </p>

    <div class="admin-card fade-in">
      <form class="admin-form" id="noticeForm">
        <div>
          <label for="noticeDate">日付</label>
          <input type="date" id="noticeDate" required>
        </div>
        <div>
          <label for="noticeTag">タグ</label>
          <select id="noticeTag">
            <option value="UPDATE">UPDATE</option>
            <option value="INFO">INFO</option>
            <option value="EVENT">EVENT</option>
            <option value="MAINTENANCE">MAINTENANCE</option>
          </select>
        </div>
        <div>
          <label for="noticeTitle">タイトル</label>
          <input type="text" id="noticeTitle" placeholder="例: Android版APKを公開しました" required>
        </div>
        <div>
          <label for="noticeBody">本文</label>
          <textarea id="noticeBody" rows="4" placeholder="例: ホーム画面のAndroidボタンからAPKをダウンロードできます。" required></textarea>
        </div>
        <div class="admin-actions">
          <button type="submit" class="admin-button">お知らせを追加</button>
          <button type="button" class="admin-button secondary" id="clearNotices">すべて削除(注意)</button>
          <button type="button" class="admin-button secondary" id="downloadJson">JSONをダウンロード</button>
        </div>
      </form>
    </div>

    <div class="admin-card fade-in">
      <h2 class="section-title" style="font-size: 24px;">プレビュー</h2>
      <div class="notice-preview" id="noticePreview"></div>
    </div>
  </div>

  <script>
    const storageKey = 'spotlight_notices';
    const form = document.getElementById('noticeForm');
    const preview = document.getElementById('noticePreview');
    const clearButton = document.getElementById('clearNotices');
    const downloadButton = document.getElementById('downloadJson');

    function loadNotices() {
      const raw = localStorage.getItem(storageKey);
      return raw ? JSON.parse(raw) : [];
    }

    function saveNotices(items) {
      localStorage.setItem(storageKey, JSON.stringify(items));
    }

    function makeKey(item) {
      return `${item.date || ''}|${item.tag || ''}|${item.title || ''}`;
    }

    function mergeNotices(primary, secondary) {
      const merged = [];
      const seen = new Set();
      [...primary, ...secondary].forEach(item => {
        const key = makeKey(item);
        if (!seen.has(key)) {
          seen.add(key);
          merged.push(item);
        }
      });
      return merged;
    }

    async function loadRemoteNotices() {
      try {
        const response = await fetch('notices.json', { cache: 'no-store' });
        if (!response.ok) {
          return [];
        }
        const data = await response.json();
        return Array.isArray(data.notices) ? data.notices : [];
      } catch (error) {
        console.warn('Failed to load notices.json', error);
        return [];
      }
    }

    function renderPreview(items) {
      if (!items.length) {
        preview.innerHTML = '<div class="notice-item">お知らせはありません。</div>';
        return;
      }
      preview.innerHTML = items.map(item => `
        <div class="notice-item">
          <div class="notice-meta">
            <span class="notice-tag">${item.tag}</span>
            <span>${item.date}</span>
          </div>
          <div style="font-weight: 700; margin-top: 6px;">${item.title}</div>
          <div style="opacity: 0.9; margin-top: 6px; white-space: pre-wrap;">${item.body}</div>
        </div>
      `).join('');
    }

    function downloadJson(items) {
      const payload = { notices: items };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'notices.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const items = loadNotices();
      const newItem = {
        date: document.getElementById('noticeDate').value,
        tag: document.getElementById('noticeTag').value,
        title: document.getElementById('noticeTitle').value.trim(),
        body: document.getElementById('noticeBody').value.trim()
      };
      items.unshift(newItem);
      saveNotices(items);
      renderPreview(items);
      form.reset();
    });

    clearButton.addEventListener('click', () => {
      const ok = window.confirm('すべてのお知らせ履歴を削除します。よろしいですか？');
      if (!ok) return;
      saveNotices([]);
      renderPreview([]);
    });

    downloadButton.addEventListener('click', () => {
      downloadJson(loadNotices());
    });

    (async () => {
      const localItems = loadNotices();
      const remoteItems = await loadRemoteNotices();
      const merged = mergeNotices(localItems, remoteItems);
      saveNotices(merged);
      renderPreview(merged);
    })();
  </script>
</body>
</html>
